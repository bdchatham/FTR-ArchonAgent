apiVersion: batch/v1
kind: Job
metadata:
  name: archon-init-db
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-postgres
        image: postgres:15-alpine
        env:
        - name: PGHOST
          value: postgres
        - name: PGPORT
          value: "5432"
        - name: PGDATABASE
          value: archon
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: archon-secrets
              key: postgres_user
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: archon-secrets
              key: postgres_password
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready; do
            echo "PostgreSQL is not ready yet..."
            sleep 2
          done
          echo "PostgreSQL is ready. Creating schema..."
          psql -c "
          CREATE TABLE IF NOT EXISTS document_state (
              repo_file_path VARCHAR(512) PRIMARY KEY,
              sha VARCHAR(64) NOT NULL,
              last_modified TIMESTAMP NOT NULL,
              last_checked TIMESTAMP NOT NULL,
              content_hash VARCHAR(64)
          );
          CREATE INDEX IF NOT EXISTS idx_last_checked ON document_state(last_checked);
          "
          echo "PostgreSQL schema created successfully."
      - name: init-qdrant
        image: curlimages/curl:8.5.0
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Qdrant to be ready..."
          until curl -f http://qdrant:6333/health; do
            echo "Qdrant is not ready yet..."
            sleep 2
          done
          echo "Qdrant is ready. Creating collection..."
          curl -X PUT http://qdrant:6333/collections/archon-docs \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 384,
                "distance": "Cosine"
              }
            }'
          echo "Qdrant collection created successfully."
